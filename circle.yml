general:
  branches:
    only:
      - beta
      - features/circle
      - stable
machine:
  environment:
    CP_MYSQL_TEST_HOST: "127.0.0.1"
    CP_MYSQL_TEST_PASSWORD: ""
    CP_MYSQL_TEST_USER: "root"
  xcode:
    version: 8.2
dependencies:
  cache_directories:
    # Cache CellProfiler’s Python dependencies:
    - /usr/local/lib/python2.7/site-packages
  pre:
    # Install CellProfiler’s Homebrew dependencies:
    - brew update && brew install awscli mysql upx python wxpython

    # Install CellProfiler’s Python dependencies and PyInstaller:
    - pip2 install --upgrade cython numpy scipy
  override:
    # Install CellProfiler:
    - pip2 install --editable ".[build, test]" --upgrade    
database:
  pre:
    # Start MySQL:
    - brew services start mysql
test:
  override:
    - python2 -m pytest
deployment:
  nightly:
    branch: features/circle
    commands:
      # Create macOS application bundle:
      - pyinstaller CellProfiler.spec

      # Copy Info.plist to application bundle:
      - cp Info.plist dist/CellProfiler.app/Contents

      # Copy Homebrew’s libpng dynamic library to application bundle:
      - >
        cp                                                    \
          `brew --cellar libpng`/1.6.31/lib/libpng16.16.dylib \
          dist/CellProfiler.app/Contents/MacOS

      # Remove duplicate wx dynamic libraries from application bundle:
      - rm dist/CellProfiler.app/Contents/MacOS/libwx*3.0.dylib
      
      # - >
      #   codesign                                                    \
      #     --deep                                                    \
      #     -s "Developer ID Application: Allen Goodman (MERWFR65Q3)" \
      #     dist/CellProfiler.app

      # Create Apple Disk Image:
      - >
        hdiutil create                     \
          -format UDRW                     \
          -fs HFS+                         \
          -fsargs "-c c=64,a=16,e=16"      \
          -size 500000k                    \
          -srcfolder dist/CellProfiler.app \
          -volname CellProfiler            \
          dist/CellProfiler-nightly.dmg
      
      # Upload to disk image to Amazon S3 (Simple Storage Service):
      - >
        aws s3 sync dist s3://cellprofiler-releases \
          --delete                                  \
          --exclude "*"                             \
          --include "CellProfiler-nightly.dmg"
  beta:
    branch: beta
  stable:
    branch: stable
