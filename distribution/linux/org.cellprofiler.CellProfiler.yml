id: org.cellprofiler.CellProfiler
runtime: org.freedesktop.Platform
# 21.08 contains python 3.9
sdk: org.freedesktop.Sdk
runtime-version: '25.08'
#runtime: org.gnome.Platform
#sdk: org.gnome.Sdk
#runtime-version: '49'
command: cellprofiler
modules:
  - name: pixi-install
    buildsystem: simple
    build-commands:
      - ${FLATPAK_BUILDER_BUILDDIR}/environment.sh --output-directory ${FLATPAK_DEST} --verbose
      - echo 'exec "$@"' >> ${FLATPAK_DEST}/activate.sh
      - chmod +x ${FLATPAK_DEST}/activate.sh
      - echo "${FLATPAK_DEST}/activate.sh python -m cellprofiler -L 10" > cellprofiler
      - install -Dm0755 cellprofiler ${FLATPAK_DEST}/bin/cellprofiler
      - pip3 --python ${FLATPAK_DEST}/env/bin/python install --no-index --no-build-isolation --no-deps --prefix=${FLATPAK_DEST}/env ${FLATPAK_BUILDER_BUILDDIR}/src/subpackages/library
      - pip3 --python ${FLATPAK_DEST}/env/bin/python install --no-index --no-build-isolation --no-deps --prefix=${FLATPAK_DEST}/env ${FLATPAK_BUILDER_BUILDDIR}/src/subpackages/core
      - pip3 --python ${FLATPAK_DEST}/env/bin/python install --no-index --no-build-isolation --no-deps --prefix=${FLATPAK_DEST}/env ${FLATPAK_BUILDER_BUILDDIR}/src/frontend
      # - ${FLATPAK_DEST}/activate.sh python -m compileall ${FLATPAK_DEST}/env/lib/python3.9/site-packages/
    sources:
      - type: git
        url: https://github.com/CellProfiler/CellProfiler.git
        commit: 826da6c07abd993e1796b403319b56ba4ce745ae
        #tag: v5.0.0
      - type: file
        path: ./environment.sh
finish-args:
  # TODO: linux - wayland support
  - --socket=x11
  # - --share=socket
  # - --share=network
  # - --filesystem=xdg-documents
  # by default set to gail:atk-bridge, which causes a load of canberra-gtk-module, which is not shipped in the flatpak
  - --env=GTK_MODULES=
  - --env=LD_PRELOAD=/usr/lib/x86_64-linux-gnu/libfontconfig.so.1
  - --env=LD_LIBRARY_PATH=/app/env/lib
